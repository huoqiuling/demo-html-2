name: 主工作流

on:
  push:
    branches: ["main"]

jobs:
  checkout:
    runs-on: ubuntu-latest
    steps:
      - name: 先列出文件
        run: ls -la
      - name: 使用 actions/checkout@v4
        uses: actions/checkout@v4
      - name: 再列出文件
        run: ls -la

  nodeVersion:
    needs: checkout
    runs-on: ubuntu-latest
    steps:
      - name: 先看看 node 版本
        run: node -v
      - name: 使用 actions/setup-node@v4
        uses: actions/setup-node@v4
        with:
          node-version: "18"
      - name: 再看看 node 版本
        run: node -v

  logSecretToken:
    needs: nodeVersion
    runs-on: ubuntu-latest
    steps:
      - name: 输出 secrets.token
        run: echo "My secret is ${{ secrets.token }}"

  show-github-xxx:
    needs: logSecretToken
    runs-on: ubuntu-latest
    steps:
      - name: 输出 github.actor
        run: echo "github.actor 是 ${{ github.actor }}"
      - name: 输出 github.ref
        run: echo "github.ref 是 ${{ github.ref }}"
      - name: 输出 github.sha
        run: echo "github.sha 是 ${{ github.sha }}"

  error:
    needs: show-github-xxx
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: 故意报错的步骤
        run: exit 1

  run-scripts:
    needs: error
    runs-on: ubuntu-latest
    steps:
      - name: 使用 actions/checkout@v4
        uses: actions/checkout@v4
      - name: 运行 hello 脚本
        run: node ./.github/workflows/hello.js

  set-a-output:
    needs: run-scripts
    runs-on: ubuntu-latest
    outputs:
      output1: ${{ steps.setoutput1.outputs.output1 }}
      output2: ${{ steps.setoutput2.outputs.output2 }}
    steps:
      - name: 设置输出变量 output1
        id: setoutput1
        run: echo "output1=看我看我" >> $GITHUB_OUTPUT
      - name: 设置输出变量 output2
        id: setoutput2
        run: echo "output2=看我看我222" >> $GITHUB_OUTPUT

  use-output:
    needs: set-a-output
    runs-on: ubuntu-latest
    steps:
      - name: 打印上一个 job
        run: echo "${{ toJson(needs.set-a-output) }}"
      - name: 使用前一步的输出变量
        run: echo "前一个 job 的 outputs是 '${{ needs.set-a-output.outputs.output1 }}' 和 '${{ needs.set-a-output.outputs.output2 }}'"

  data-between-steps:
    runs-on: ubuntu-latest
    steps:
      - name: 生成随机数
        id: random
        run: echo "value=$((RANDOM % 100))" >> $GITHUB_OUTPUT
      - name: 使用上一步的随机数
        run: echo "上一步生成的随机数是 ${{ steps.random.outputs.value }}"
      - name: 再次使用上一步的随机数
        run: echo "我又来使用这个随机数 ${{ steps.random.outputs.value }} 了"

  log-env:
    runs-on: ubuntu-latest
    steps:
      - name: 输出所有环境变量
        run: env
      - name: 输出 GITHUB_ 开头的变量
        run: env | grep ^GITHUB_

  eslint:
    needs: data-between-steps
    runs-on: ubuntu-latest
    steps:
      - name: 使用 actions/checkout@v4
        uses: actions/checkout@v4
      - name: 设置 Node.js 版本
        uses: actions/setup-node@v4
        with:
          node-version: "18"
      - name: 安装 eslint
        run: npm install -g eslint
      - name: 查看 eslint 版本
        run: eslint -v
      - name: 运行 eslint 检查代码
        run: eslint . --ext .js,.jsx,.ts,.tsx

  prettier:
    needs: eslint
    runs-on: ubuntu-latest
    steps:
      - name: 使用 actions/checkout@v4
        uses: actions/checkout@v4
      - name: 设置 Node.js 版本
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: 安装 prettier
        run: npm install -g prettier
      - name: 查看 prettier 版本
        run: prettier -v
      - name: 运行 prettier 检查代码格式
        run: prettier --check "**/*.{js,jsx,ts,tsx,json,css,md}"
